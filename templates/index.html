<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Arqueo de Caja</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { padding:20px; background:#f7f9fc; }
      .card { box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
      .badge-green { background:#198754; color:white; }
      .badge-red { background:#dc3545; color:white; }
      .small-muted { font-size:0.9rem; color:#6c757d; }
      /* Cabecera compacta */
      .compact-header .form-label { font-size: 0.85rem; margin-bottom: 0.15rem; }
      .compact-header { padding-top: .5rem !important; padding-bottom: .5rem !important; }
      .denom-input {
        padding: 0.25rem 0.5rem;
        font-size: 0.85rem;
        height: auto;
      }
      .denom-label {
        font-size: 0.8rem;
        margin-bottom: 0.2rem;
        font-weight: 500;
      }
      #calcSave:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }
      .compact-invoice input {
        padding: 0.2rem 0.4rem;
        font-size: 0.8rem;
        height: auto;
      }
       .compact-invoice label {
         font-size: 0.75rem;
         margin-bottom: 0.15rem;
       }
      /* Resumen compacto */
      .compact-summary { padding-top: .5rem !important; padding-bottom: .5rem !important; }
      .compact-summary h5, .compact-summary h6 { margin: 0 0 .25rem 0; font-size: .95rem; }
      .compact-summary #summary { font-size: .9rem; }
      .compact-summary .alert { padding: .35rem .5rem; margin-bottom: .25rem; }
     </style>
  </head>
  <body>
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2>Arqueo de Caja</h2>
        <div>
          <button id="clearBtn" class="btn btn-outline-secondary">Limpiar campos</button>
          <button id="loadList" class="btn btn-outline-primary">Ver últimos arqueos</button>
        </div>
      </div>

      <div class="card p-2 mb-2 compact-header">
        <div class="row g-1 align-items-end">
          <div class="col-md-4">
            <label class="form-label mb-1">Cajero/a</label>
            <input id="cashier" class="form-control form-control-sm" placeholder="Nombre">
          </div>
          <div class="col-md-3">
            <label class="form-label mb-1">Turno</label>
            <select id="shift" class="form-select form-select-sm">
              <option value="12:00 pm">Cierre 12:00 pm</option>
              <option value="5:30 pm">Cierre 5:30 pm</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label mb-1">Fecha</label>
            <input id="date" type="date" class="form-control form-control-sm" value="{{ today }}">
          </div>
          <div class="col-md-2">
            <label class="form-label mb-1">Fondo inicial</label>
            <input id="starting_fund" type="number" step="0.01" class="form-control form-control-sm" value="0">
          </div>
        </div>
      </div>

      <div class="row">
        <!-- Columna Izquierda -->
        <div class="col-md-6">
          <div class="card p-3 mb-3">
            <h5>Desglose billetes y monedas</h5>
            <div id="denomList" class="row g-1">
              {% for d in denominations %}
              <div class="col-4 col-sm-3 col-md-4">
                <label class="form-label denom-label">{{ d }}</label>
                <input type="number" min="0" class="form-control denom-input denom" data-denom="{{ d }}" value="0">
              </div>
              {% endfor %}
            </div>
            <hr>
            <h5>Entradas que no son efectivo</h5>
            <div class="input-group mb-2 compact-invoice">
              <select id="noncash_tipo" class="form-select form-select-sm">
                <option value="cheques">Cheques</option>
                <option value="tarjetas">Tarjetas</option>
                <option value="vales">Vales</option>
                <option value="transferencias">Transferencias</option>
                <option value="recibos">Recibos</option>
                <option value="depositos">Depósitos</option>
                <option value="otros">Otros</option>
              </select>
              <input id="noncash_descripcion" class="form-control form-control-sm" placeholder="Descripción (opcional)">
              <input id="noncash_monto" type="number" step="0.01" class="form-control form-control-sm" placeholder="Monto">
              <button id="addNonCash" class="btn btn-success btn-sm">Agregar</button>
            </div>
            <div id="noncashList" class="list-group mb-2"></div>
            <!-- Sección de totales eliminada - ahora solo aparece en el resumen -->
          </div>
        </div>
        
        <!-- Columna Derecha -->
        <div class="col-md-6">
          <div class="card p-2 mb-2 compact-summary">
            <h5>Resumen y Totales</h5>
            <div id="summary" class="mb-1 small-muted">Aún no hay cálculos.</div>
            <div class="d-flex gap-2">
              <button id="saveBtn" class="btn btn-secondary btn-sm">Guardar</button>
              <button id="downloadPdf" class="btn btn-primary btn-sm">Generar PDF</button>
            </div>
            <div id="lastSaved" class="mt-2"></div>
          </div>

          <div class="card p-3 mb-3">
            <h5>Facturas al contado</h5>
            <div class="row g-1 compact-invoice">
              <div class="col-md-4">
                <label class="form-label small mb-1">Consumidor Final</label>
                <div class="row g-1">
                  <div class="col-6"><input id="fc_cf_desde" class="form-control form-control-sm" placeholder="Desde"></div>
                  <div class="col-6"><input id="fc_cf_hasta" class="form-control form-control-sm" placeholder="Hasta"></div>
                </div>
                <input id="fc_cf_monto" type="number" step="0.01" class="form-control form-control-sm mt-1" value="0" placeholder="Monto">
              </div>
              <div class="col-md-4">
                <label class="form-label small mb-1">Consumidor Fiscal</label>
                <div class="row g-1">
                  <div class="col-6"><input id="fc_fiscal_desde" class="form-control form-control-sm" placeholder="Desde"></div>
                  <div class="col-6"><input id="fc_fiscal_hasta" class="form-control form-control-sm" placeholder="Hasta"></div>
                </div>
                <input id="fc_fiscal_monto" type="number" step="0.01" class="form-control form-control-sm mt-1" value="0" placeholder="Monto">
              </div>
              <div class="col-md-4">
                <label class="form-label small mb-1">Recibos</label>
                <div class="row g-1">
                  <div class="col-6"><input id="fc_recibo_desde" class="form-control form-control-sm" placeholder="Desde"></div>
                  <div class="col-6"><input id="fc_recibo_hasta" class="form-control form-control-sm" placeholder="Hasta"></div>
                </div>
                <input id="fc_recibo_monto" type="number" step="0.01" class="form-control form-control-sm mt-1" value="0" placeholder="Monto">
              </div>
            </div>
            <hr>
            <h5>Facturas a crédito</h5>
            <small class="small-muted">Agrega por tipo: consumidor final, comprobante fiscal, vieje</small>
            <div class="mt-2">
              <div class="input-group mb-2">
                <select id="cred_tipo" class="form-select">
                  <option value="consumidor final">Consumidor final</option>
                  <option value="comprobante fiscal">Comprobante fiscal</option>
                  <option value="vieje">Vieje</option>
                </select>
                <input id="cred_num" class="form-control" placeholder="Número factura">
                <input id="cred_monto" type="number" step="0.01" class="form-control" placeholder="Monto">
                <button id="addCred" class="btn btn-success">Agregar</button>
              </div>
              <div id="creditList" class="list-group"></div>
            </div>
          </div>
        </div>
        
        <!-- Modal para lista de arqueos -->
        <div class="modal fade" id="listModal" tabindex="-1" aria-labelledby="listModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="listModalLabel">Últimos Arqueos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body" id="listModalBody">
                <!-- Contenido dinámico -->
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

<script>
function gatherData() {
  const counts = {};
  document.querySelectorAll('.denom').forEach(el=>{
    counts[el.dataset.denom] = parseInt(el.value||0);
  });
  const noncash_list = [];
  const noncash_totals = {};
  
  // Inicializar totales para cada tipo
  ['cheques', 'tarjetas', 'vales', 'transferencias', 'recibos', 'depositos', 'otros'].forEach(tipo => {
    noncash_totals[tipo] = 0;
  });
  
  // Recopilar entradas no efectivo dinámicas
  document.querySelectorAll('.noncash-item').forEach(item => {
    const tipo = item.dataset.tipo;
    const descripcion = item.dataset.descripcion;
    const monto = parseFloat(item.dataset.monto);
    
    noncash_list.push({
      tipo: tipo,
      descripcion: descripcion,
      monto: monto
    });
    
    noncash_totals[tipo] += monto;
  });
  
  const noncash = noncash_totals;
  const fact_contado = {
    consumidor_final: {
      desde: document.getElementById('fc_cf_desde').value,
      hasta: document.getElementById('fc_cf_hasta').value,
      monto: parseFloat(document.getElementById('fc_cf_monto').value||0)
    },
    consumidor_fiscal: {
      desde: document.getElementById('fc_fiscal_desde').value,
      hasta: document.getElementById('fc_fiscal_hasta').value,
      monto: parseFloat(document.getElementById('fc_fiscal_monto').value||0)
    },
    recibos: {
      desde: document.getElementById('fc_recibo_desde').value,
      hasta: document.getElementById('fc_recibo_hasta').value,
      monto: parseFloat(document.getElementById('fc_recibo_monto').value||0)
    }
  };
  const fact_credito = [];
  document.querySelectorAll('.cred-item').forEach(it=>{
    fact_credito.push({
      tipo: it.dataset.tipo,
      numero: it.dataset.num,
      monto: parseFloat(it.dataset.monto)
    });
  });
  return {
    date: document.getElementById('date').value,
    cashier: document.getElementById('cashier').value,
    shift: document.getElementById('shift').value,
    starting_fund: parseFloat(document.getElementById('starting_fund').value||0),
    counts, noncash, noncash_list, fact_contado, fact_credito
  };
}

document.getElementById('addCred').addEventListener('click', ()=>{
  const tipo = document.getElementById('cred_tipo').value;
  const num = document.getElementById('cred_num').value;
  const monto = document.getElementById('cred_monto').value || 0;
  if(!num) return alert('Ingrese número de factura');
  const item = document.createElement('div');
  item.className = 'list-group-item cred-item';
  item.dataset.tipo = tipo; item.dataset.num = num; item.dataset.monto = monto;
  item.innerHTML = `<div class="d-flex justify-content-between align-items-center"><div><strong>${tipo}</strong> Nº ${num} — ${parseFloat(monto).toFixed(2)}</div><button class="btn btn-sm btn-danger">Eliminar</button></div>`;
  item.querySelector('button').addEventListener('click', ()=> {
    item.remove();
    updateSummary();
  });
  document.getElementById('creditList').appendChild(item);
  document.getElementById('cred_num').value=''; document.getElementById('cred_monto').value='';
  
  // Actualizar resumen
  updateSummary();
});

document.getElementById('addNonCash').addEventListener('click', addNonCashEntry);
   
   // Event listeners para actualización automática del resumen
   setTimeout(() => {
     // Campos de denominaciones (billetes y monedas)
     document.querySelectorAll('.denom').forEach(input => {
       input.addEventListener('input', updateSummary);
     });
     
     // Facturas al contado
     const facturasContado = ['fc_cf', 'fc_fiscal', 'fc_recibo'];
     facturasContado.forEach(prefix => {
       const desdeInput = document.getElementById(`${prefix}_desde`);
       const hastaInput = document.getElementById(`${prefix}_hasta`);
       const montoInput = document.getElementById(`${prefix}_monto`);
       
       if (desdeInput) desdeInput.addEventListener('input', updateSummary);
       if (hastaInput) hastaInput.addEventListener('input', updateSummary);
       if (montoInput) montoInput.addEventListener('input', updateSummary);
     });
     
     // Fondo inicial
     const startingFund = document.getElementById('starting_fund');
     if (startingFund) startingFund.addEventListener('input', updateSummary);
     
     // Campos de no efectivo
     const noncashMonto = document.getElementById('noncash_monto');
     if (noncashMonto) noncashMonto.addEventListener('input', updateSummary);
     
     // Actualizar resumen al cargar la página
    updateSummary();
  }, 100);

function addNonCashEntry() {
  const tipo = document.getElementById('noncash_tipo').value;
  const descripcion = document.getElementById('noncash_descripcion').value;
  const monto = parseFloat(document.getElementById('noncash_monto').value) || 0;
  
  if (monto <= 0) {
    alert('Por favor ingrese un monto válido');
    return;
  }
  
  const listContainer = document.getElementById('noncashList');
  const itemId = 'noncash_' + Date.now();
  
  const listItem = document.createElement('div');
  listItem.className = 'list-group-item d-flex justify-content-between align-items-center noncash-item';
  listItem.id = itemId;
  listItem.dataset.tipo = tipo;
  listItem.dataset.descripcion = descripcion;
  listItem.dataset.monto = monto;
  
  const descripcionText = descripcion ? ` (${descripcion})` : '';
  listItem.innerHTML = `
    <div>
      <strong>${tipo.charAt(0).toUpperCase() + tipo.slice(1)}</strong>${descripcionText}
      <span class="badge bg-primary ms-2">$${monto.toFixed(2)}</span>
    </div>
    <button class="btn btn-danger btn-sm" onclick="removeNonCashEntry('${itemId}')">Eliminar</button>
  `;
  
  listContainer.appendChild(listItem);
  
  // Limpiar campos
  document.getElementById('noncash_descripcion').value = '';
  document.getElementById('noncash_monto').value = '';
  
  // Actualizar totales y resumen
  updateNonCashTotals();
  updateSummary();
}

function removeNonCashEntry(itemId) {
  const item = document.getElementById(itemId);
  if (item) {
    item.remove();
    updateNonCashTotals();
    updateSummary();
  }
}

function updateNonCashTotals() {
    const totales = {};
    ['cheques', 'tarjetas', 'vales', 'transferencias', 'recibos', 'depositos', 'otros'].forEach(tipo => {
      totales[tipo] = 0;
    });
    
    document.querySelectorAll('.noncash-item').forEach(item => {
      const tipo = item.dataset.tipo;
      const monto = parseFloat(item.dataset.monto);
      totales[tipo] += monto;
    });
    
    return totales;
  }
  
  function updateSummary() {
    // Calcular totales en tiempo real
    const counts = {};
    document.querySelectorAll('.denom-input').forEach(el => {
      counts[el.dataset.denom] = parseInt(el.value || 0);
    });
    
    // Calcular total efectivo
    let cashTotal = 0;
    Object.keys(counts).forEach(denom => {
      cashTotal += parseInt(denom) * counts[denom];
    });
    
    // Calcular totales no efectivo
    const noncashTotals = updateNonCashTotals();
    let noncashTotal = 0;
    Object.values(noncashTotals).forEach(val => {
      noncashTotal += val;
    });
    
    // Calcular facturas al contado
    const factContado = {};
    const tiposMap = {
      'consumidor_final': 'fc_cf',
      'consumidor_fiscal': 'fc_fiscal', 
      'recibos': 'fc_recibo'
    };
    
    Object.keys(tiposMap).forEach(tipo => {
      const prefix = tiposMap[tipo];
      const desdeInput = document.getElementById(`${prefix}_desde`);
      const hastaInput = document.getElementById(`${prefix}_hasta`);
      const montoInput = document.getElementById(`${prefix}_monto`);
      
      if (desdeInput && hastaInput && montoInput) {
        factContado[tipo] = {
          desde: desdeInput.value,
          hasta: hastaInput.value,
          monto: parseFloat(montoInput.value || 0)
        };
      } else {
        factContado[tipo] = { desde: '', hasta: '', monto: 0 };
      }
    });
    
    let totalFactContado = 0;
    Object.values(factContado).forEach(fact => {
      totalFactContado += fact.monto;
    });
    
    // Calcular facturas a crédito
    const creditItems = [];
    document.querySelectorAll('.cred-item').forEach(item => {
      creditItems.push({
        tipo: item.dataset.tipo,
        numero: item.dataset.numero,
        monto: parseFloat(item.dataset.monto)
      });
    });
    
    let totalCredito = 0;
    creditItems.forEach(item => {
      totalCredito += item.monto;
    });
    
    // Calcular balance general
    const balanceGeneral = cashTotal + noncashTotal;
    const diferencia = balanceGeneral - totalFactContado;
    
    // Actualizar el resumen
    const summaryDiv = document.getElementById('summary');
    if (summaryDiv) {
      summaryDiv.innerHTML = `
        <div class="alert alert-info">
          <h6>Resumen Automático</h6>
          <div class="row">
            <div class="col-md-6">
              <small><strong>Efectivo:</strong> $${cashTotal.toFixed(2)}</small><br>
              <small><strong>No Efectivo:</strong> $${noncashTotal.toFixed(2)}</small><br>
              <small><strong>Balance General:</strong> $${balanceGeneral.toFixed(2)}</small>
            </div>
            <div class="col-md-6">
              <small><strong>Fact. Contado:</strong> $${totalFactContado.toFixed(2)}</small><br>
              <small><strong>Fact. Crédito:</strong> $${totalCredito.toFixed(2)}</small><br>
              <small><strong>Diferencia:</strong> $${diferencia.toFixed(2)} ${diferencia > 0 ? '(SOBRA)' : diferencia < 0 ? '(FALTA)' : '(CUADRADO)'}</small>
            </div>
          </div>
        </div>
      `;
      summaryDiv.style.display = 'block';
    }
  }

document.getElementById('clearBtn').addEventListener('click', ()=>{
  document.querySelectorAll('input').forEach(i=>{
    if(i.type==='number') i.value = 0;
    else if(i.type==='date') i.value = '{{ today }}';
    else i.value = '';
  });
  document.getElementById('shift').selectedIndex = 0;
  document.getElementById('creditList').innerHTML='';
  document.getElementById('noncashList').innerHTML='';
  document.getElementById('summary').innerText = 'Campos limpiados.';
  document.getElementById('lastSaved').innerHTML='';
  document.getElementById('starting_fund').value = 0;
});

document.getElementById('downloadPdf').addEventListener('click', ()=>{
  const button = document.getElementById('downloadPdf');
  const originalText = button.innerHTML;
  button.innerHTML = 'Generando PDF...';
  button.disabled = true;
  
  try {
    const data = gatherData();
    console.log('Enviando datos para PDF:', data);
    
    fetch('/report', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data)
    })
    .then(r => {
      if (!r.ok) {
        throw new Error(`HTTP error! status: ${r.status}`);
      }
      return r.blob();
    })
    .then(blob => {
      // Crear link de descarga
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `arqueo_${data.date}_${data.cashier}_${data.shift}.pdf`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      
      // Mostrar mensaje de éxito
      document.getElementById('lastSaved').innerHTML = '<div class="alert alert-success">PDF generado exitosamente</div>';
      button.innerHTML = 'PDF Generado ✓';
      setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
      }, 2000);
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error al generar PDF: ' + error.message);
      button.innerHTML = originalText;
      button.disabled = false;
    });
  } catch (error) {
    console.error('Error:', error);
    alert('Error al procesar datos: ' + error.message);
    button.innerHTML = originalText;
    button.disabled = false;
  }
});

// Guardar sin generar PDF
document.getElementById('saveBtn').addEventListener('click', ()=>{
  const btn = document.getElementById('saveBtn');
  const original = btn.innerHTML;
  btn.innerHTML = 'Guardando...';
  btn.disabled = true;
  document.getElementById('lastSaved').innerHTML='';
  try {
    const data = gatherData();
    fetch('/save', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data)
    })
    .then(r=>{
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    })
    .then(res=>{
      const id = res.id;
      document.getElementById('lastSaved').innerHTML = `<div class="alert alert-success">Arqueo guardado (ID ${id}).</div>`;
      btn.innerHTML = 'Guardado ✓';
      setTimeout(()=>{ btn.innerHTML = original; btn.disabled = false; }, 2000);
    })
    .catch(err=>{
      console.error(err);
      alert('Error al guardar: '+ err.message);
      btn.innerHTML = original; btn.disabled = false;
    });
  } catch(err) {
    console.error(err);
    alert('Error al procesar datos: '+ err.message);
    btn.innerHTML = original; btn.disabled = false;
  }
});

document.getElementById('loadList').addEventListener('click', ()=>{
  fetch('/list').then(r=>r.json()).then(data=>{
    let html = `<div class="card p-3"><h5>Últimos arqueos</h5><ul class="list-group">`;
    data.forEach(i=>{
      html += `<li class="list-group-item d-flex justify-content-between align-items-center">ID ${i.id} — ${i.date} — ${i.cashier} <span><a target="_blank" class="btn btn-sm btn-primary" href="/report/${i.id}">PDF</a></span></li>`;
    });
    html += `</ul></div>`;
    document.getElementById('listModalBody').innerHTML = html;
    // Mostrar modal usando Bootstrap
    const modal = new bootstrap.Modal(document.getElementById('listModal'));
    modal.show();
  });
});
</script>
  </body>
</html>
